require "thor"
require 'uri'
require 'json'
require 'net/http'
require 'pp'

class Sirupsen < Thor
  desc "buttondown", "Download buttondown emails"
  def buttondown(name = nil)
    json = `curl -s -H "Authorization: Token #{ENV['BUTTONDOWN_TOKEN']}" https:///api.buttondown.email/v1/emails`
    result = JSON.parse(json)
    emails = result['results']
    emails.each do |email|
      filename = "./content/napkin/#{email["slug"].gsub("napkin-", "")}.md"
      next if File.exist?(filename)
      puts 'yes'
      File.open(filename, 'w') do |f|
        f.write("---\n")
        f.write("date: #{email["publish_date"]}\n")
        f.write("title: #{email["subject"]}\n")
        f.write("---\n\n")
        f.write(email["body"])
      end
    end
  end
end

Sirupsen.start(ARGV)
